"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.obtenerVentas=obtenerVentas;exports.obtenerVentaPorId=obtenerVentaPorId;exports.guardarVentas=guardarVentas;exports.borrarVenta=borrarVenta;exports.editarVenta=editarVenta;var _Venta=_interopRequireDefault(require("../models/Venta"));var _VentaDetalle=_interopRequireDefault(require("../models/VentaDetalle"));var _Cliente=_interopRequireDefault(require("../models/Cliente"));var _Producto=_interopRequireDefault(require("../models/Producto"));function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj};}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value;}catch(error){reject(error);return;}if(info.done){resolve(value);}else{Promise.resolve(value).then(_next,_throw);}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value);}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err);}_next(undefined);});};}function obtenerVentas(_x,_x2){return _obtenerVentas.apply(this,arguments);}function _obtenerVentas(){_obtenerVentas=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function _callee(req,res){var usuarioid,ventas;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:usuarioid=req.body.usuarioid;_context.next=3;return _Venta["default"].findAll({where:{usuarioid:usuarioid},include:[{model:_Cliente["default"]}]});case 3:ventas=_context.sent;res.json(ventas);case 5:case"end":return _context.stop();}}},_callee);}));return _obtenerVentas.apply(this,arguments);}function obtenerVentaPorId(_x3,_x4){return _obtenerVentaPorId.apply(this,arguments);}function _obtenerVentaPorId(){_obtenerVentaPorId=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function _callee2(req,res){var ventaid,usuarioid,venta;return regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;ventaid=req.params.ventaid;usuarioid=req.body.usuarioid;_context2.next=5;return _Venta["default"].findOne({where:{ventaid:ventaid},include:[{model:_Cliente["default"]}]});case 5:venta=_context2.sent;if(venta){_context2.next=8;break;}return _context2.abrupt("return",res.status(404).json({message:'Orden no existe!'}));case 8:if(!(usuarioid!=venta.usuarioid)){_context2.next=10;break;}return _context2.abrupt("return",res.status(403).json({message:'La peticion a la API no es valida'}));case 10:_context2.next=12;return _VentaDetalle["default"].findAll({where:{ventaid:ventaid},include:[{model:_Producto["default"],attributes:['descripcion','codigoproducto']}]});case 12:venta.dataValues.ventaItems=_context2.sent;res.json(venta);_context2.next=20;break;case 16:_context2.prev=16;_context2.t0=_context2["catch"](0);console.log(_context2.t0);res.status(500).json({message:'Uups, algo ha ido mal!'});case 20:case"end":return _context2.stop();}}},_callee2,null,[[0,16]]);}));return _obtenerVentaPorId.apply(this,arguments);}function guardarVentas(_x5,_x6){return _guardarVentas.apply(this,arguments);}function _guardarVentas(){_guardarVentas=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function _callee4(req,res){var _req$body,clienteid,total,ventaItems,usuarioid,fecha,nuevaVenta,ventaid;return regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.prev=0;_req$body=req.body,clienteid=_req$body.clienteid,total=_req$body.total,ventaItems=_req$body.ventaItems,usuarioid=_req$body.usuarioid;fecha=Date.now();_context4.next=5;return _Venta["default"].create({clienteid:clienteid,total:total,fecha:fecha,usuarioid:usuarioid},{fields:['clienteid','total','fecha','usuarioid']});case 5:nuevaVenta=_context4.sent;ventaid=nuevaVenta.ventaid;ventaItems.forEach(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function _callee3(ventaItem){var productoid,precio;return regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:productoid=ventaItem.productoid,precio=ventaItem.precio;_context3.next=3;return _VentaDetalle["default"].create({ventaid:ventaid,productoid:productoid,precio:precio},{fields:['ventaid','productoid','precio']});case 3:case"end":return _context3.stop();}}},_callee3);}));return function(_x11){return _ref.apply(this,arguments);};}());res.json({message:'Guardado con exito!'});_context4.next=15;break;case 11:_context4.prev=11;_context4.t0=_context4["catch"](0);console.log(_context4.t0);res.status(500).json({message:'Uups, algo ha ido mal!'});case 15:case"end":return _context4.stop();}}},_callee4,null,[[0,11]]);}));return _guardarVentas.apply(this,arguments);}function borrarVenta(_x7,_x8){return _borrarVenta.apply(this,arguments);}function _borrarVenta(){_borrarVenta=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function _callee5(req,res){var ventaid;return regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.prev=0;ventaid=req.params.ventaid;_context5.next=4;return _VentaDetalle["default"].destroy({where:{ventaid:ventaid}});case 4:_context5.next=6;return _Venta["default"].destroy({where:{ventaid:ventaid}});case 6:res.json({message:'Se eliminÃ³ con exito'});_context5.next=13;break;case 9:_context5.prev=9;_context5.t0=_context5["catch"](0);console.log(_context5.t0);res.status(500).json({message:'Uups, algo ha ido mal!'});case 13:case"end":return _context5.stop();}}},_callee5,null,[[0,9]]);}));return _borrarVenta.apply(this,arguments);}function editarVenta(_x9,_x10){return _editarVenta.apply(this,arguments);}function _editarVenta(){_editarVenta=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function _callee8(req,res){var ventaid,_req$body2,clienteid,total,ventaItems,usuarioid,ventaItemsDel;return regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.prev=0;ventaid=req.params.ventaid;_req$body2=req.body,clienteid=_req$body2.clienteid,total=_req$body2.total,ventaItems=_req$body2.ventaItems,usuarioid=_req$body2.usuarioid,ventaItemsDel=_req$body2.ventaItemsDel;_context8.next=5;return _Venta["default"].update({clienteid:clienteid,total:total,usuarioid:usuarioid},{where:{ventaid:ventaid}});case 5:if(ventaItemsDel.length>0){ventaItemsDel.forEach(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function _callee6(ventadetalleid){return regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.next=2;return _VentaDetalle["default"].destroy({where:{ventadetalleid:ventadetalleid}});case 2:case"end":return _context6.stop();}}},_callee6);}));return function(_x12){return _ref2.apply(this,arguments);};}());}ventaItems.forEach(/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function _callee7(ventaItem){var productoid,precio,ventadetalleid;return regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:productoid=ventaItem.productoid,precio=ventaItem.precio,ventadetalleid=ventaItem.ventadetalleid;if(!ventadetalleid){_context7.next=6;break;}_context7.next=4;return _VentaDetalle["default"].update({productoid:productoid,precio:precio},{where:{ventadetalleid:ventadetalleid}});case 4:_context7.next=8;break;case 6:_context7.next=8;return _VentaDetalle["default"].create({ventaid:ventaid,productoid:productoid,precio:precio},{fields:['ventaid','productoid','precio']});case 8:case"end":return _context7.stop();}}},_callee7);}));return function(_x13){return _ref3.apply(this,arguments);};}());res.json({message:'Editado con exito!'});_context8.next=14;break;case 10:_context8.prev=10;_context8.t0=_context8["catch"](0);console.log(_context8.t0);res.status(500).json({message:'Uups, algo ha ido mal!'});case 14:case"end":return _context8.stop();}}},_callee8,null,[[0,10]]);}));return _editarVenta.apply(this,arguments);}